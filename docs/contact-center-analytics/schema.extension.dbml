// Расширение схемы для production-метрик контакт-центра.
// Что добавили и зачем:
// 1) queue_event / agent_event / message_event — сырые события для SLA/ASA/response time и состояния операторов.
// 2) fact_interaction_timing — нормализованные тайминги по обращению (answer wait, first response, handle).
// 3) fact_queue_interval — интервальные/снапшотные метрики очереди (глубина, service level, abandoned).
// 4) dim_* — согласованные справочники для интеграции с внешними master-системами.
// 5) fact_sentiment / fact_outcome — production-источники для виджетов «Эмоциональный фон» и «Достижение цели».

Enum queue_event_type {
  joined
  answered
  abandoned
  snapshot
  left
}

Enum agent_state_code {
  ready
  on_call
  after_call_work
  break
  offline
}

Enum message_event_type {
  message_received
  first_response_sent
  message_sent
  conversation_closed
}

Enum direction_code {
  inbound
  outbound
}

Table dim_department {
  id bigserial [pk]
  source_system varchar(64) [not null]
  source_key varchar(128) [not null]
  department_code varchar(64) [not null]
  name_ru varchar(255) [not null]
  is_active boolean [not null, default: true]
  valid_from timestamptz [not null, default: `now()`]
  valid_to timestamptz
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    (source_system, source_key) [unique]
    (department_code)
  }
}

Table dim_channel {
  id bigserial [pk]
  source_system varchar(64) [not null]
  source_key varchar(128) [not null]
  channel_code varchar(32) [not null]
  name_ru varchar(128) [not null]
  is_active boolean [not null, default: true]
  valid_from timestamptz [not null, default: `now()`]
  valid_to timestamptz
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    (source_system, source_key) [unique]
    (channel_code)
  }
}

Table dim_queue {
  id bigserial [pk]
  source_system varchar(64) [not null]
  source_key varchar(128) [not null]
  queue_code varchar(64) [not null]
  name_ru varchar(255) [not null]
  department_id bigint [not null, ref: > dim_department.id]
  is_active boolean [not null, default: true]
  valid_from timestamptz [not null, default: `now()`]
  valid_to timestamptz
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    (source_system, source_key) [unique]
    (queue_code)
    (department_id)
  }
}

Table dim_agent {
  id bigserial [pk]
  source_system varchar(64) [not null]
  source_key varchar(128) [not null]
  agent_code varchar(64) [not null]
  full_name_ru varchar(255) [not null]
  department_id bigint [ref: > dim_department.id]
  is_active boolean [not null, default: true]
  valid_from timestamptz [not null, default: `now()`]
  valid_to timestamptz
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    (source_system, source_key) [unique]
    (agent_code)
    (department_id)
  }
}

Table dim_topic {
  id bigserial [pk]
  source_system varchar(64) [not null]
  source_key varchar(128) [not null]
  topic_code varchar(128) [not null]
  name_ru varchar(255) [not null]
  is_active boolean [not null, default: true]
  valid_from timestamptz [not null, default: `now()`]
  valid_to timestamptz
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    (source_system, source_key) [unique]
    (topic_code)
  }
}

Table queue_event {
  id bigserial [pk]
  event_id varchar(128) [not null]
  source_system varchar(64) [not null]
  event_type queue_event_type [not null]
  occurred_at timestamptz [not null]

  call_id varchar(128)
  conversation_id varchar(128)
  external_id varchar(64)

  queue_id bigint [not null, ref: > dim_queue.id]
  channel_id bigint [ref: > dim_channel.id]
  agent_id bigint [ref: > dim_agent.id]

  wait_sec int [note: 'Ожидание до текущего события (если применимо).']
  queue_depth int [note: 'Глубина очереди на момент snapshot/joined.']
  sla_target_sec int [note: 'Порог SLA для очереди/канала.']
  payload jsonb

  created_at timestamptz [not null, default: `now()`]

  indexes {
    (source_system, event_id) [unique]
    (occurred_at)
    (queue_id, occurred_at)
    (call_id)
    (conversation_id)
    (external_id)
  }
}

Table agent_event {
  id bigserial [pk]
  event_id varchar(128) [not null]
  source_system varchar(64) [not null]
  occurred_at timestamptz [not null]

  agent_id bigint [not null, ref: > dim_agent.id]
  queue_id bigint [ref: > dim_queue.id]
  state agent_state_code [not null]

  call_id varchar(128)
  conversation_id varchar(128)
  external_id varchar(64)
  payload jsonb

  created_at timestamptz [not null, default: `now()`]

  indexes {
    (source_system, event_id) [unique]
    (agent_id, occurred_at)
    (state, occurred_at)
    (call_id)
    (conversation_id)
    (external_id)
  }
}

Table message_event {
  id bigserial [pk]
  event_id varchar(128) [not null]
  source_system varchar(64) [not null]
  event_type message_event_type [not null]
  occurred_at timestamptz [not null]

  conversation_id varchar(128)
  external_id varchar(64)
  call_id varchar(128)

  channel_id bigint [not null, ref: > dim_channel.id]
  queue_id bigint [ref: > dim_queue.id]
  agent_id bigint [ref: > dim_agent.id]
  direction direction_code [not null, default: 'inbound']

  response_sec int [note: 'Для first_response_sent: сек до первого ответа.']
  payload jsonb

  created_at timestamptz [not null, default: `now()`]

  indexes {
    (source_system, event_id) [unique]
    (occurred_at)
    (channel_id, occurred_at)
    (conversation_id)
    (external_id)
    (direction, occurred_at)
  }
}

Table fact_interaction_timing {
  interaction_id bigint [pk, note: 'FK на interactions.id из базовой схемы.']

  call_id varchar(128)
  conversation_id varchar(128)
  direction direction_code [not null, default: 'inbound']

  queue_join_at timestamptz
  answer_at timestamptz
  first_response_at timestamptz
  closed_at timestamptz

  answer_wait_sec int [note: 'ASA-компонента: время от queue_join_at до answer_at.']
  first_response_sec int [note: 'Для chat/email/sms/push: время до первого ответа.']
  handle_sec int [note: 'Фактическая длительность обработки (может отличаться от interactions.duration_sec).']

  source_quality_score numeric(5,2) [note: 'Оценка качества склейки событий.']
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    (answer_at)
    (first_response_at)
    (direction)
    (call_id)
    (conversation_id)
  }
}

Table fact_queue_interval {
  id bigserial [pk]
  queue_id bigint [not null, ref: > dim_queue.id]
  channel_id bigint [ref: > dim_channel.id]
  snapshot_at timestamptz [not null]

  waiting_count int [not null, default: 0, note: 'Текущее число ожидающих в очереди (queue depth).']
  joined_total int [not null, default: 0]
  answered_total int [not null, default: 0]
  abandoned_total int [not null, default: 0]

  asa_sec int [note: 'Average Speed of Answer за интервал.']
  response_avg_sec int [note: 'Средний response time для non-voice за интервал.']
  response_p95_sec int [note: 'p95 response time для non-voice за интервал.']

  sla_target_sec int [not null, default: 20]
  answered_in_sla int [not null, default: 0]
  service_level_pct numeric(6,2) [note: '100 * answered_in_sla / answered_total.']

  created_at timestamptz [not null, default: `now()`]

  indexes {
    (queue_id, snapshot_at)
    (channel_id, snapshot_at)
    (snapshot_at)
  }

  constraints {
    `waiting_count >= 0` [name: 'chk_fqi_waiting_non_negative']
    `joined_total >= 0 AND answered_total >= 0 AND abandoned_total >= 0` [name: 'chk_fqi_totals_non_negative']
    `answered_in_sla >= 0` [name: 'chk_fqi_sla_non_negative']
  }
}

Table fact_sentiment {
  interaction_id bigint [pk, note: 'FK на interactions.id']
  sentiment_label varchar(32) [not null, note: 'positive/neutral/negative']
  sentiment_score numeric(5,2)
  source_system varchar(64) [not null, default: 'nlp']
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    (sentiment_label)
  }
}

Table fact_outcome {
  interaction_id bigint [pk, note: 'FK на interactions.id']
  outcome_code varchar(64) [not null, note: 'resolved/escalated/requires_actions']
  outcome_name_ru varchar(255) [not null]
  source_system varchar(64) [not null, default: 'crm']
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    (outcome_code)
  }
}
