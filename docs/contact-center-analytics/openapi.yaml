openapi: 3.0.3
info:
  title: API расширенной аналитики контакт-центра
  version: 1.0.0
  description: |
    API для загрузки обращений (ingestion) и получения агрегатов (analytics)
    для UI "Расширенная аналитика контакт-центра".
servers:
  - url: /
    description: Текущий хост (Vercel/локальный)

tags:
  - name: Ingestion
    description: Загрузка и нормализация данных в БД
  - name: Dictionaries
    description: Чтение справочников
  - name: Analytics
    description: Агрегаты для графиков и таблиц UI
  - name: Analytics (cc_replica)
    description: Аналитика поверх схемы cc_replica  

paths:
  /api/dictionaries/queues/v2:
    get:
      tags: 
      - Dictionaries (cc_replica)
      summary: Справочник очередей (v2, cc_replica)
      responses:
        '200':
          description: Список очередей
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/DictionaryChannel'
  
  /api/dictionaries/channels/v2:
    get:
      tags: 
      - Dictionaries (cc_replica)
      summary: Справочник каналов (v2, cc_replica)
      responses:
        '200':
          description: Список каналов
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/DictionaryChannel'

  
  /api/dictionaries/departments/v2:
    get:
      tags:
        - Dictionaries (cc_replica)
      summary: Справочник отделов (v2)
      description: Dictionary backed by cc_replica."Department".
      operationId: getDictionaryDepartmentsV2
      parameters:
        - in: query
          name: q
          schema: { type: string }
          required: false
          description: Search by code/name.
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 200, default: 50 }
          required: false
        - in: query
          name: offset
          schema: { type: integer, minimum: 0, default: 0 }
          required: false
        - in: query
          name: debug
          schema: { type: string, enum: ["0","1"] }
          required: false
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      type: object
                      required: [id, code, nameRu]
                      properties:
                        id: { type: string, format: uuid }
                        code: { type: string }
                        nameRu: { type: string }
                        active: { type: boolean }
                  limit: { type: integer }
                  offset: { type: integer }
        "500":
          description: Database error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"


  /api/ingest/interactions:
    post:
      tags: [Ingestion]
      summary: Batch upsert обращений по externalId
      description: |
        Принимает пачку обращений, нормализует справочники (каналы/очереди/отделы/операторы/тематики),
        затем делает upsert в `interactions` по `external_id`.
        Русские входные статусы (`statusRu`) маппятся в англ. enum:
        - Завершён -> completed
        - Пропущен -> missed
        - Ожидание -> waiting
        - В разговоре -> in_progress
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IngestInteractionsRequest'
            examples:
              demo:
                summary: Пример пачки из 2 обращений
                value:
                  items:
                    - externalId: C-10492
                      startedAt: '2026-01-30T09:15:00+03:00'
                      channelCode: voice
                      queueCode: general
                      departmentCode: contact_center
                      departmentNameRu: Контакт-центр
                      operatorName: Иван Петров
                      topicName: Сброс пароля
                      durationSec: 360
                      statusRu: Завершён
                    - externalId: C-10493
                      startedAt: '2026-01-30T09:16:00+03:00'
                      channelCode: chat
                      queueCode: vip
                      departmentCode: quality_control
                      departmentNameRu: Контроль качества
                      operatorName: Анна Соколова
                      topicName: Авторизация ЛК
                      durationSec: 0
                      statusRu: Пропущен
      responses:
        '200':
          description: Пачка обработана
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestInteractionsResponse'
        '400':
          description: Ошибка валидации входных данных
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Внутренняя ошибка сервиса
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/dictionaries/TicketSubjectOut:
    get:
      tags:
        - Dictionaries (cc_replica)
      summary: Тематики обращений исходящих звонков
      description: Dictionary backed by cc_replica."TicketSubjectOut".
      operationId: getDictionaryTicketSubjectOut
      parameters:
        - in: query
          name: q
          schema: { type: string }
          required: false
          description: Search by name.
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 200, default: 50 }
          required: false
        - in: query
          name: offset
          schema: { type: integer, minimum: 0, default: 0 }
          required: false
        - in: query
          name: debug
          schema: { type: string, enum: ["0","1"] }
          required: false
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      type: object
                      required: [id, code, nameRu]
                      properties:
                        id: { type: string }
                        code: { type: string }
                        nameRu: { type: string }
                        active: { type: boolean }
                  limit: { type: integer }
                  offset: { type: integer }
        "500":
          description: Database error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/dictionaries/channels:
    get:
      tags: [Dictionaries]
      summary: Справочник каналов
      responses:
        '200':
          description: Список каналов
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/DictionaryChannel'

  /api/dictionaries/queues:
    get:
      tags: [Dictionaries]
      summary: Справочник очередей
      responses:
        '200':
          description: Список очередей
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/DictionaryQueue'

  /api/dictionaries/departments:
    get:
      tags: [Dictionaries]
      summary: Справочник отделов
      responses:
        '200':
          description: Список отделов
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/DictionaryDepartment'

  /api/dictionaries/operators:
    get:
      tags: [Dictionaries]
      summary: Справочник операторов
      responses:
        '200':
          description: Список операторов
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/DictionaryOperator'

  /api/dictionaries/users:
    get:
      tags: [Dictionaries (cc_replica)]
      summary: Справочник пользователей
      description: |
        Возвращает список пользователей из `cc_replica."User"`.
        По умолчанию возвращаются только активные пользователи.
        Установите `all=true`, чтобы включить неактивных.
      parameters:
        - in: query
          name: all
          required: false
          description: Include inactive users in the response when set to true.
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: List of users
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                        code:
                          type: string
                        nameRu:
                          type: string
                      required: [id, code, nameRu]
                required: [items]
                
  /api/dictionaries/TicketSubject:
    get:
      tags: [Dictionaries (cc_replica)]
      summary: Тематики обращений входящих звонков
      operationId: getDictionaryTicketSubject
      parameters:
        - in: query
          name: all
          schema: { type: string, enum: ["0","1"] }
          required: false
        - in: query
          name: debug
          schema: { type: string, enum: ["0","1"] }
          required: false
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      type: object
                      required: [id, code, nameRu]
                      properties:
                        id: { type: string }
                        code: { type: string }
                        nameRu: { type: string }
                        active: { type: boolean }
        "500":
          description: Database error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/dictionaries/topics:
    get:
      tags: [Dictionaries]
      summary: Справочник тематик
      responses:
        '200':
          description: Список тематик
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/DictionaryTopic'
  /api/analytics/recent/v2:
    get:
      tags:
        - Analytics (cc_replica)
      summary: Последние коммуникации (v2, cc_replica)
      description: Лента обращений из cc_replica."Call" с JOIN на справочники.
      operationId: getRecentV2
      parameters:
        - $ref: '#/components/parameters/period'
        - $ref: '#/components/parameters/from'
        - $ref: '#/components/parameters/to'
        - $ref: '#/components/parameters/dept'
        - $ref: '#/components/parameters/channel'
        - $ref: '#/components/parameters/queue'
        - $ref: '#/components/parameters/topic'
        - $ref: '#/components/parameters/q'
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/offset'
      responses:
        '200':
          description: Список обращений, отсортированных по startedAt desc
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecentResponse'
        '500':
          description: Database error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'


  /api/analytics/sentiment/v2:
    get:
      tags: 
      - Analytics (cc_replica)
      summary: Эмоциональный фон (v2, cc_replica)
      description: Аналитика поверх схемы cc_replica  
      operationId: getSentimentV2
      responses:
        '200':
          description: Donut-распределение эмоционального фона
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SentimentResponse'
        '500':
          description: Database error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
 
  /api/analytics/kpis:
    get:
      tags: [Analytics]
      summary: KPI карточки (входящие, пропущенные, AHT, нагрузка, FCR)
      parameters:
        - $ref: '#/components/parameters/period'
        - $ref: '#/components/parameters/from'
        - $ref: '#/components/parameters/to'
        - $ref: '#/components/parameters/dept'
        - $ref: '#/components/parameters/channel'
        - $ref: '#/components/parameters/queue'
        - $ref: '#/components/parameters/topic'
        - $ref: '#/components/parameters/q'
      responses:
        '200':
          description: KPI агрегаты
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KpisResponse'

  /api/analytics/timeseries:
    get:
      tags: [Analytics]
      summary: Временные ряды incoming/missed/ahtSec
      parameters:
        - $ref: '#/components/parameters/period'
        - $ref: '#/components/parameters/from'
        - $ref: '#/components/parameters/to'
        - $ref: '#/components/parameters/dept'
        - $ref: '#/components/parameters/channel'
        - $ref: '#/components/parameters/queue'
        - $ref: '#/components/parameters/topic'
        - $ref: '#/components/parameters/q'
        - in: query
          name: granularity
          required: false
          schema:
            type: string
            enum: [auto, hour, day]
            default: auto
          description: |
            auto: hour для today/yesterday/7d, day для 30d/custom (или по вашей бизнес-логике).
      responses:
        '200':
          description: Ряд для линейных графиков обзора
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TimeSeriesResponse'

  /api/analytics/channels/split:
    get:
      tags: [Analytics]
      summary: Канальные агрегаты (распределение, объёмы, скорость реакции)
      parameters:
        - $ref: '#/components/parameters/period'
        - $ref: '#/components/parameters/from'
        - $ref: '#/components/parameters/to'
        - $ref: '#/components/parameters/dept'
        - $ref: '#/components/parameters/channel'
        - $ref: '#/components/parameters/queue'
        - $ref: '#/components/parameters/topic'
        - $ref: '#/components/parameters/q'
      responses:
        '200':
          description: Агрегаты по каналам
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChannelsSplitResponse'

  /api/analytics/operators:
    get:
      tags: [Analytics]
      summary: Метрики по операторам (load, quality, trend)
      parameters:
        - $ref: '#/components/parameters/period'
        - $ref: '#/components/parameters/from'
        - $ref: '#/components/parameters/to'
        - $ref: '#/components/parameters/dept'
        - $ref: '#/components/parameters/channel'
        - $ref: '#/components/parameters/queue'
        - $ref: '#/components/parameters/topic'
        - $ref: '#/components/parameters/q'
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/offset'
      responses:
        '200':
          description: Операторские агрегаты
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OperatorsResponse'

  /api/analytics/queues:
    get:
      tags: [Analytics]
      summary: Метрики по очередям (SLA, ожидание, брошенные, динамика длины)
      description: |
        Поля `waiting`, `avgWaitSec`, `slaPct`, `queueDepthTrend` могут быть null,
        если не подключены события очередей (`queue_state_events`: joined/answered/abandoned/snapshot).
      parameters:
        - $ref: '#/components/parameters/period'
        - $ref: '#/components/parameters/from'
        - $ref: '#/components/parameters/to'
        - $ref: '#/components/parameters/dept'
        - $ref: '#/components/parameters/channel'
        - $ref: '#/components/parameters/queue'
        - $ref: '#/components/parameters/topic'
        - $ref: '#/components/parameters/q'
      responses:
        '200':
          description: Агрегаты по очередям
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueuesResponse'

  /api/analytics/topics/top:
    get:
      tags: [Analytics]
      summary: Топ тематик + тематические donut-агрегаты
      parameters:
        - $ref: '#/components/parameters/period'
        - $ref: '#/components/parameters/from'
        - $ref: '#/components/parameters/to'
        - $ref: '#/components/parameters/dept'
        - $ref: '#/components/parameters/channel'
        - $ref: '#/components/parameters/queue'
        - $ref: '#/components/parameters/topic'
        - $ref: '#/components/parameters/q'
        - $ref: '#/components/parameters/limit'
      responses:
        '200':
          description: Агрегаты по тематикам
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TopicsTopResponse'

  /api/analytics/topics/timeseries:
    get:
      tags: [Analytics]
      summary: Тренд по тематике (incoming/missed)
      parameters:
        - $ref: '#/components/parameters/period'
        - $ref: '#/components/parameters/from'
        - $ref: '#/components/parameters/to'
        - $ref: '#/components/parameters/dept'
        - $ref: '#/components/parameters/channel'
        - $ref: '#/components/parameters/queue'
        - $ref: '#/components/parameters/topic'
        - $ref: '#/components/parameters/q'
        - in: query
          name: topic
          required: true
          schema:
            type: string
          description: '`all` или id/код тематики.'
      responses:
        '200':
          description: Временной ряд по теме
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TopicTimeSeriesResponse'

  /api/analytics/recent:
    get:
      tags: [Analytics]
      summary: Последние коммуникации (лента/таблица)
      parameters:
        - $ref: '#/components/parameters/period'
        - $ref: '#/components/parameters/from'
        - $ref: '#/components/parameters/to'
        - $ref: '#/components/parameters/dept'
        - $ref: '#/components/parameters/channel'
        - $ref: '#/components/parameters/queue'
        - $ref: '#/components/parameters/topic'
        - $ref: '#/components/parameters/q'
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/offset'
      responses:
        '200':
          description: Список обращений, отсортированных по startedAt desc
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecentResponse'

  /api/analytics/sentiment:
    get:
      tags: [Analytics]
      summary: Эмоциональный фон (donut по communicationColor)
      description: |
        Минимальный MVP-агрегат по таблице WMT responses.
        Считает распределение коммуникаций по цвету: red/yellow/green.
      parameters:
        - $ref: '#/components/parameters/sentimentFrom'
        - $ref: '#/components/parameters/sentimentTo'
        - $ref: '#/components/parameters/sentimentStatus'
        - $ref: '#/components/parameters/sentimentActive'
        - $ref: '#/components/parameters/q'
      responses:
        '200':
          description: Donut-распределение эмоционального фона
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SentimentResponse'

components:
  parameters:
    period:
      in: query
      name: period
      required: false
      schema:
        type: string
        enum: [today, yesterday, 7d, 30d, custom]
        default: today
      description: Пресет периода.
    from:
      in: query
      name: from
      required: false
      schema:
        type: string
        format: date-time
      description: Начало периода (обязательно при period=custom).
    to:
      in: query
      name: to
      required: false
      schema:
        type: string
        format: date-time
      description: Конец периода (обязательно при period=custom).
    dept:
      in: query
      name: dept
      required: false
      schema:
        type: string
      description: Код или id отдела.
    channel:
      in: query
      name: channel
      required: false
      schema:
        type: string
      description: Код или id канала.
    queue:
      in: query
      name: queue
      required: false
      schema:
        type: string
      description: Код или id очереди.
    topic:
      in: query
      name: topic
      required: false
      schema:
        type: string
      description: id/код тематики или `all`.
    q:
      in: query
      name: q
      required: false
      schema:
        type: string
      description: Поиск по externalId, оператору, теме.
    sentimentFrom:
      in: query
      name: from
      required: false
      schema:
        oneOf:
          - type: string
            format: date-time
          - type: string
            format: date
      description: Начало периода (допускается дата или дата-время).
    sentimentTo:
      in: query
      name: to
      required: false
      schema:
        oneOf:
          - type: string
            format: date-time
          - type: string
            format: date
      description: Конец периода (допускается дата или дата-время).
    sentimentStatus:
      in: query
      name: status
      required: false
      schema:
        type: string
      description: |
        Фильтр по статусу WMT response. Если колонка `status` есть и параметр не передан,
        по умолчанию используется `success`.
    sentimentActive:
      in: query
      name: active
      required: false
      schema:
        oneOf:
          - type: boolean
          - type: string
      description: |
        Фильтр по флагу активности WMT response. Если колонка `active` есть и параметр
        не передан, по умолчанию используется `true`.
    limit:
      in: query
      name: limit
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 500
        default: 50
    offset:
      in: query
      name: offset
      required: false
      schema:
        type: integer
        minimum: 0
        default: 0

  schemas:
    IngestInteractionsRequest:
      type: object
      required: [items]
      properties:
        items:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/IngestInteractionItem'

    IngestInteractionItem:
      type: object
      required:
        - externalId
        - startedAt
        - channelCode
        - queueCode
        - durationSec
        - statusRu
      properties:
        externalId:
          type: string
          description: Внешний id обращения (уникальный ключ upsert).
        startedAt:
          type: string
          format: date-time
        channelCode:
          type: string
          enum: [voice, chat, email, sms, push]
        queueCode:
          type: string
          example: general
        departmentCode:
          type: string
          nullable: true
        departmentNameRu:
          type: string
          nullable: true
        operatorName:
          type: string
          nullable: true
        topicName:
          type: string
          nullable: true
        durationSec:
          type: integer
          minimum: 0
        statusRu:
          type: string
          enum: ['Завершён', 'Пропущен', 'Ожидание', 'В разговоре']

    IngestInteractionsResponse:
      type: object
      properties:
        inserted:
          type: integer
        updated:
          type: integer
        rejected:
          type: integer
        errors:
          type: array
          items:
            $ref: '#/components/schemas/IngestError'

    IngestError:
      type: object
      properties:
        index:
          type: integer
          description: Позиция элемента в request.items.
        externalId:
          type: string
          nullable: true
        code:
          type: string
          example: VALIDATION_ERROR
        message:
          type: string

    DictionaryChannel:
      type: object
      properties:
        id: { type: integer }
        code: { type: string, enum: [voice, chat, email, sms, push] }
        nameRu: { type: string }

    DictionaryQueue:
      type: object
      properties:
        id: { type: integer }
        code: { type: string }
        nameRu: { type: string }
        departmentId: { type: integer }

    DictionaryDepartment:
      type: object
      properties:
        id: { type: integer }
        code: { type: string }
        nameRu: { type: string }

    DictionaryOperator:
      type: object
      properties:
        id: { type: integer }
        code: { type: string }
        fullNameRu: { type: string }
        departmentId:
          type: integer
          nullable: true

    DictionaryTopic:
      type: object
      properties:
        id: { type: integer }
        code: { type: string }
        nameRu: { type: string }

    KpisResponse:
      type: object
      properties:
        incoming: { type: integer }
        missed: { type: integer }
        ahtSec:
          type: integer
          nullable: true
        operatorsOnCalls: { type: integer }
        operatorsTotal: { type: integer }
        fcrPct:
          type: number
          format: float
        avgWaitSec:
          type: integer
          nullable: true
          description: Требует queue_state_events или interaction_stage_events.
        slaPct:
          type: number
          format: float
          nullable: true
          description: Требует события очереди (join/answer/abandon).
      example:
        incoming: 246
        missed: 29
        ahtSec: 311
        operatorsOnCalls: 32
        operatorsTotal: 44
        fcrPct: 88.2
        avgWaitSec: null
        slaPct: null

    TimeSeriesPoint:
      type: object
      properties:
        t:
          type: string
          description: Точка времени (например 2026-01-30T09:00:00+03:00).
        incoming: { type: integer }
        missed: { type: integer }
        ahtSec:
          type: integer
          nullable: true

    TimeSeriesResponse:
      type: object
      properties:
        granularity: { type: string, enum: [hour, day] }
        items:
          type: array
          items:
            $ref: '#/components/schemas/TimeSeriesPoint'
      example:
        granularity: hour
        items:
          - t: '2026-01-30T09:00:00+03:00'
            incoming: 42
            missed: 4
            ahtSec: 298
          - t: '2026-01-30T10:00:00+03:00'
            incoming: 39
            missed: 5
            ahtSec: 305

    ChannelsSplitItem:
      type: object
      properties:
        channelCode:
          type: string
          enum: [voice, chat, email, sms, push]
        channelNameRu:
          type: string
        incoming: { type: integer }
        outgoing:
          type: integer
          nullable: true
          description: Требует признак направления (direction=inbound/outbound).
        responseSec:
          type: integer
          nullable: true
          description: Требует события первого ответа/этапов обработки.

    ChannelResponseTrendPoint:
      type: object
      properties:
        t: { type: string }
        voice: { type: integer, nullable: true }
        chat: { type: integer, nullable: true }
        email: { type: integer, nullable: true }
        sms: { type: integer, nullable: true }
        push: { type: integer, nullable: true }

    ChannelsSplitResponse:
      type: object
      properties:
        split:
          type: array
          items:
            $ref: '#/components/schemas/ChannelsSplitItem'
        responseTrend:
          type: array
          items:
            $ref: '#/components/schemas/ChannelResponseTrendPoint'
      example:
        split:
          - channelCode: voice
            channelNameRu: Звонки
            incoming: 120
            outgoing: null
            responseSec: null
          - channelCode: chat
            channelNameRu: Чат
            incoming: 70
            outgoing: null
            responseSec: null
        responseTrend:
          - t: '2026-01-30T09:00:00+03:00'
            voice: null
            chat: null
            email: null
            sms: null
            push: null

    OperatorItem:
      type: object
      properties:
        operatorId: { type: integer }
        operatorNameRu: { type: string }
        handled: { type: integer }
        missed: { type: integer }
        ahtSec: { type: integer, nullable: true }
        fcrPct: { type: number, format: float }

    OperatorTrendPoint:
      type: object
      properties:
        t: { type: string }
        ahtSec: { type: integer, nullable: true }
        asaSec:
          type: integer
          nullable: true
          description: Требует queue_state_events/agent_state_events или interaction_stage_events.

    OperatorsResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/OperatorItem'
        trend:
          type: array
          items:
            $ref: '#/components/schemas/OperatorTrendPoint'
      example:
        items:
          - operatorId: 101
            operatorNameRu: Иван Петров
            handled: 34
            missed: 4
            ahtSec: 305
            fcrPct: 86.8
        trend:
          - t: '2026-01-30T09:00:00+03:00'
            ahtSec: 298
            asaSec: null

    QueueItem:
      type: object
      properties:
        queueCode: { type: string }
        queueNameRu: { type: string }
        total: { type: integer }
        abandonedPct:
          type: number
          format: float
          nullable: true
        waiting:
          type: integer
          nullable: true
          description: Текущее число в очереди. Нужны queue_state_events.
        avgWaitSec:
          type: integer
          nullable: true
          description: Среднее ожидание до ответа/сброса. Нужны queue_state_events.
        slaPct:
          type: number
          format: float
          nullable: true
          description: Доля обращений в SLA-пороге. Нужны queue_state_events.

    QueueDepthTrendPoint:
      type: object
      properties:
        t: { type: string }
        general: { type: integer, nullable: true }
        vip: { type: integer, nullable: true }
        antifraud: { type: integer, nullable: true }

    QueuesResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/QueueItem'
        queueDepthTrend:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/QueueDepthTrendPoint'
      example:
        items:
          - queueCode: general
            queueNameRu: Общая
            total: 150
            abandonedPct: 11.3
            waiting: null
            avgWaitSec: null
            slaPct: null
        queueDepthTrend: null

    TopicTopItem:
      type: object
      properties:
        topicId: { type: integer }
        topicNameRu: { type: string }
        count: { type: integer }
        avgHandleSec: { type: integer, nullable: true }
        fcrPct: { type: number, format: float }

    DonutSlice:
      type: object
      properties:
        nameRu: { type: string }
        value: { type: number, format: float }

    TopicsTopResponse:
      type: object
      properties:
        topTopics:
          type: array
          items:
            $ref: '#/components/schemas/TopicTopItem'
        channelSplit:
          type: array
          items:
            $ref: '#/components/schemas/DonutSlice'
        sentimentSplit:
          type: array
          nullable: true
          description: Для production лучше считать из NLP/QA разметки.
          items:
            $ref: '#/components/schemas/DonutSlice'
        goalSplit:
          type: array
          nullable: true
          description: Для production лучше считать из CRM outcome.
          items:
            $ref: '#/components/schemas/DonutSlice'
      example:
        topTopics:
          - topicId: 10
            topicNameRu: Сброс пароля
            count: 48
            avgHandleSec: 245
            fcrPct: 91.0
        channelSplit:
          - nameRu: Звонки
            value: 55
          - nameRu: Чат
            value: 30
        sentimentSplit: null
        goalSplit: null

    TopicTimeSeriesPoint:
      type: object
      properties:
        t: { type: string }
        incoming: { type: integer }
        missed: { type: integer }

    TopicTimeSeriesResponse:
      type: object
      properties:
        topic:
          type: string
          description: all или конкретная тема.
        items:
          type: array
          items:
            $ref: '#/components/schemas/TopicTimeSeriesPoint'
      example:
        topic: all
        items:
          - t: '2026-01-30T09:00:00+03:00'
            incoming: 22
            missed: 2

    RecentItem:
      type: object
      properties:
        externalId: { type: string }
        startedAt: { type: string, format: date-time }
        channelCode: { type: string, enum: [voice, chat, email, sms, push] }
        channelNameRu: { type: string }
        queueCode: { type: string }
        queueNameRu: { type: string }
        departmentNameRu: { type: string }
        operatorNameRu:
          type: string
          nullable: true
        topicNameRu:
          type: string
          nullable: true
        durationSec: { type: integer }
        statusCode:
          type: string
          enum: [completed, missed, waiting, in_progress]
        statusRu:
          type: string
          enum: ['Завершён', 'Пропущен', 'Ожидание', 'В разговоре']

    RecentResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/RecentItem'
        total:
          type: integer
      example:
        items:
          - externalId: C-10492
            startedAt: '2026-01-30T09:15:00+03:00'
            channelCode: voice
            channelNameRu: Звонки
            queueCode: general
            queueNameRu: Общая
            departmentNameRu: Контакт-центр
            operatorNameRu: Иван Петров
            topicNameRu: Сброс пароля
            durationSec: 360
            statusCode: completed
            statusRu: Завершён
        total: 1

    SentimentResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/DonutSlice'
        total:
          type: integer
          description: Сумма value по всем сегментам.
      example:
        items:
          - nameRu: Негатив
            value: 10
          - nameRu: Нейтрально
            value: 20
          - nameRu: Позитив
            value: 30
        total: 60

    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code: { type: string, example: BAD_REQUEST }
            message: { type: string, example: Некорректные параметры запроса }
            details:
              type: array
              items:
                type: string
